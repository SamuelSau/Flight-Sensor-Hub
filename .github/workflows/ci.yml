name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck on project source
        run: |
          cppcheck \
            --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=missingInclude \
            --inline-suppr \
            -I src/ -I src/bsp -I src/app -I src/util \
            -I cmsis/Include -I cmsis/Device/ST/STM32F4xx/Include \
            -I freertos -I freertos/kernel/include \
            -I freertos/kernel/portable/GCC/ARM_CM4F \
            -DSTM32F446xx \
            src/ startup/

      - name: Check for trailing whitespace
        run: |
          if grep -rn --include='*.c' --include='*.h' ' $' src/ startup/ freertos/FreeRTOSConfig.h; then
            echo "::error::Trailing whitespace found"
            exit 1
          fi

      - name: Check for tabs in project source
        run: |
          if grep -rPn --include='*.c' --include='*.h' '\t' src/ startup/ freertos/FreeRTOSConfig.h; then
            echo "::error::Tab characters found (use spaces)"
            exit 1
          fi

  build:
    name: Build (${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=arm-none-eabi-gcc.cmake \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build build 2>&1

      - name: Verify artifacts exist
        run: |
          test -f build/src/FlightSensorHub.elf || { echo "::error::ELF not found"; exit 1; }
          test -f build/src/FlightSensorHub.bin || { echo "::error::BIN not found"; exit 1; }
          test -f build/src/FlightSensorHub.map || { echo "::error::MAP not found"; exit 1; }

      - name: Print binary size
        run: arm-none-eabi-size build/src/FlightSensorHub.elf

      - name: Check flash usage (must fit in 512K)
        run: |
          TEXT=$(arm-none-eabi-size build/src/FlightSensorHub.elf | tail -1 | awk '{print $1}')
          DATA=$(arm-none-eabi-size build/src/FlightSensorHub.elf | tail -1 | awk '{print $2}')
          FLASH_USED=$((TEXT + DATA))
          FLASH_MAX=524288
          echo "Flash usage: ${FLASH_USED} / ${FLASH_MAX} bytes ($(( FLASH_USED * 100 / FLASH_MAX ))%)"
          if [ "$FLASH_USED" -gt "$FLASH_MAX" ]; then
            echo "::error::Flash overflow! ${FLASH_USED} > ${FLASH_MAX}"
            exit 1
          fi

      - name: Check SRAM usage (must fit in 128K)
        run: |
          DATA=$(arm-none-eabi-size build/src/FlightSensorHub.elf | tail -1 | awk '{print $2}')
          BSS=$(arm-none-eabi-size build/src/FlightSensorHub.elf | tail -1 | awk '{print $3}')
          SRAM_USED=$((DATA + BSS))
          SRAM_MAX=131072
          echo "SRAM usage: ${SRAM_USED} / ${SRAM_MAX} bytes ($(( SRAM_USED * 100 / SRAM_MAX ))%)"
          if [ "$SRAM_USED" -gt "$SRAM_MAX" ]; then
            echo "::error::SRAM overflow! ${SRAM_USED} > ${SRAM_MAX}"
            exit 1
          fi

      - name: Upload ELF artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.build_type }}
          path: |
            build/src/FlightSensorHub.elf
            build/src/FlightSensorHub.bin
            build/src/FlightSensorHub.map

  build-warnings:
    name: Build with strict warnings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=arm-none-eabi-gcc.cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-Werror -Wpedantic -Wshadow -Wconversion -Wdouble-promotion"

      - name: Build with -Werror
        run: cmake --build build 2>&1

  binary-analysis:
    name: Binary analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi

      - name: Download firmware artifact
        uses: actions/download-artifact@v4
        with:
          name: firmware-Release
          path: build/src/

      - name: Verify vector table entry point
        run: |
          # First word should be initial SP (top of 128K SRAM = 0x20020000)
          FIRST_WORD=$(arm-none-eabi-objdump -s -j .isr_vector build/src/FlightSensorHub.elf | \
            grep '^ 0800' | head -1 | awk '{print $2}')
          echo "Initial SP (little-endian): ${FIRST_WORD}"

          # Second word should be Reset_Handler address (in flash, 0x0800xxxx)
          SECOND_WORD=$(arm-none-eabi-objdump -s -j .isr_vector build/src/FlightSensorHub.elf | \
            grep '^ 0800' | head -1 | awk '{print $3}')
          echo "Reset vector (little-endian): ${SECOND_WORD}"

      - name: Check for unresolved symbols
        run: |
          UNDEF=$(arm-none-eabi-nm -u build/src/FlightSensorHub.elf 2>/dev/null || true)
          if [ -n "$UNDEF" ]; then
            echo "Undefined symbols found:"
            echo "$UNDEF"
            echo "::warning::Undefined symbols detected (may be expected for weak aliases)"
          fi

      - name: List section sizes
        run: arm-none-eabi-objdump -h build/src/FlightSensorHub.elf

      - name: Check TelemetryPacket size in binary
        run: |
          # The packet struct should be exactly 38 bytes (packed)
          # Verify by checking sizeof in the symbol table or map
          echo "Expected TelemetryPacket size: 38 bytes"
          if grep -q 'TelemetryPacket' build/src/FlightSensorHub.map; then
            echo "TelemetryPacket symbol found in map file"
          fi

  clang-format-check:
    name: Formatting check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format

      - name: Check formatting (advisory)
        continue-on-error: true
        run: |
          find src/ startup/ -name '*.c' -o -name '*.h' | \
            xargs clang-format --dry-run --Werror --style="{BasedOnStyle: LLVM, IndentWidth: 4, ColumnLimit: 100}" 2>&1 || \
            echo "::warning::Some files don't match clang-format style (advisory only)"
